<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Immich Kiosk Gallery</title>
  <link rel="stylesheet" href="/static/slideshow.css">
</head>
<body>
  <header class="gallery-header">
    <div id="collection-switcher" class="collection-switcher"></div>
    <div id="memories-label" class="memories-label">Spomienky</div>
  </header>
  <main>
    <div id="slideshow" class="slideshow">
      <img id="slide-img-prev" class="slide-image" alt="Previous" />
      <img id="slide-img" class="slide-image" alt="Current" />
      <img id="slide-img-preview" class="slide-image slide-preview" alt="Preview" />
      <div id="loading" class="loading">Načítavam fotky...</div>
    </div>
    <div id="photo-meta" class="photo-meta">
      <span id="photo-date"></span>
      <span id="photo-author"></span>
      <span id="photo-location"></span>
      <span id="photo-index"></span>
    </div>
  </main>
  <script>
    // Modern, robust, and simple slideshow logic
    // --- Immich Kiosk Gallery Slideshow ---
    const switcher = document.getElementById('collection-switcher');
    const memoriesLabel = document.getElementById('memories-label');
    const slideImg = document.getElementById('slide-img');
    const slideImgPrev = document.getElementById('slide-img-prev');
    const slideImgPreview = document.getElementById('slide-img-preview');
    const loading = document.getElementById('loading');
    const photoDate = document.getElementById('photo-date');
    const photoAuthor = document.getElementById('photo-author');
    const photoLocation = document.getElementById('photo-location');
    const photoIndex = document.getElementById('photo-index');

    let collections = {
      memories: [],
      random: []
    };
    let currentCollection = 'memories';
    let slideIndex = 0;
    let slideTimer = null;
    let lastSlideIndex = 0;
    let preloadCache = {};

    function showLoading(show) {
      loading.style.display = show ? 'block' : 'none';
    }

    async function fetchCollections() {
      showLoading(true);
      const [memoriesRes, randomRes] = await Promise.all([
        fetch('/api/memories').then(r => r.json()),
        fetch('/api/randomPhotos').then(r => r.json())
      ]);
      collections.memories = (memoriesRes.success && memoriesRes.memories) ? memoriesRes.memories : [];
      collections.random = (randomRes.success && randomRes.photos) ? randomRes.photos : [];
      showLoading(false);
    }

    function availableCollections() {
      return Object.entries(collections)
        .filter(([k, v]) => Array.isArray(v) && v.length)
        .map(([k]) => k);
    }

    function renderSwitcher() {
      const avail = availableCollections();
      if (avail.length < 2) {
        switcher.style.display = 'none';
        return;
      }
      switcher.innerHTML = '';
      avail.forEach(col => {
        const label = document.createElement('label');
        label.className = 'switch-label';
        label.innerHTML = `<input type="radio" name="collection" value="${col}" ${currentCollection===col?'checked':''}>${col==='memories'?'Spomienky':'Náhodné fotky'}`;
        label.onclick = () => switchCollection(col);
        switcher.appendChild(label);
      });
      switcher.style.display = 'flex';
    }

    function switchCollection(col) {
      if (col === currentCollection) return;
      currentCollection = col;
      slideIndex = 0;
      updateMemoriesLabel();
      showSlide(slideIndex, true);
      restartSlideshow();
    }

    function updateMemoriesLabel() {
      if (currentCollection === 'memories') {
        memoriesLabel.classList.add('active');
        memoriesLabel.style.display = 'block';
      } else {
        memoriesLabel.classList.remove('active');
        memoriesLabel.style.display = 'none';
      }
    }

    function getCurrentPhotos() {
      return collections[currentCollection] || [];
    }

    function preloadImage(url) {
      if (!url || preloadCache[url]) return;
      const img = new window.Image();
      img.src = url;
      preloadCache[url] = img;
    }

    function showSlide(idx, instant = false) {
      const photos = getCurrentPhotos();
      if (!photos.length) {
        [slideImg, slideImgPrev, slideImgPreview].forEach(img => img.style.display = 'none');
        [photoDate, photoAuthor, photoLocation, photoIndex].forEach(el => el.style.display = 'none');
        return;
      }
      const photo = photos[idx % photos.length];
      const prevPhoto = photos[lastSlideIndex % photos.length];
      const direction = idx > lastSlideIndex || (idx === 0 && lastSlideIndex === photos.length - 1) ? 'right' : 'left';

      // Show blurred preview
      slideImgPreview.src = photo.thumbnail_url || '';
      slideImgPreview.style.display = photo.thumbnail_url ? 'block' : 'none';

      // Prepare previous image for slide-out
      slideImgPrev.src = slideImg.src || '';
      slideImgPrev.style.display = slideImg.src ? 'block' : 'none';
      slideImgPrev.className = 'slide-image slide-center';

      // Prepare new image for slide-in
      slideImg.className = 'slide-image ' + (instant ? 'slide-center' : (direction === 'right' ? 'slide-in-right' : 'slide-in-left'));
      slideImg.style.display = 'block';
      slideImg.src = photo.full_image_url || photo.thumbnail_url;

      // Animate after load
      slideImg.onload = () => {
        slideImgPreview.style.display = 'none';
        setTimeout(() => {
          slideImg.className = 'slide-image slide-center';
          slideImgPrev.className = 'slide-image ' + (direction === 'right' ? 'slide-out-left' : 'slide-out-right');
        }, instant ? 0 : 30);
        setTimeout(() => {
          slideImgPrev.style.display = 'none';
        }, instant ? 0 : 600);
      };
      // If cached, trigger animation immediately
      if (slideImg.complete) {
        slideImgPreview.style.display = 'none';
        setTimeout(() => {
          slideImg.className = 'slide-image slide-center';
          slideImgPrev.className = 'slide-image ' + (direction === 'right' ? 'slide-out-left' : 'slide-out-right');
        }, instant ? 0 : 30);
        setTimeout(() => {
          slideImgPrev.style.display = 'none';
        }, instant ? 0 : 600);
      }

      // Preload next image
      if (photos.length > 1) {
        const nextIdx = (idx + 1) % photos.length;
        const nextPhoto = photos[nextIdx];
        if (nextPhoto && nextPhoto.full_image_url) preloadImage(nextPhoto.full_image_url);
      }

      // Metadáta
      // Date
      let dateStr = '';
      if (photo.file_created_at) {
        const d = new Date(photo.file_created_at);
        if (!isNaN(d.getTime())) {
          dateStr = d.toLocaleDateString('sk-SK', { year: 'numeric', month: 'long', day: 'numeric' });
        }
      }
      photoDate.textContent = dateStr;
      photoDate.style.display = dateStr ? 'inline' : 'none';
      // Author
      photoAuthor.textContent = photo.author ? `Autor: ${photo.author}` : '';
      photoAuthor.style.display = photo.author ? 'inline' : 'none';
      // Location
      let loc = '';
      if (photo.city) loc += photo.city;
      if (photo.state) loc += (loc ? ', ' : '') + photo.state;
      if (photo.country) loc += (loc ? ', ' : '') + photo.country;
      photoLocation.textContent = loc ? `Lokácia: ${loc}` : '';
      photoLocation.style.display = loc ? 'inline' : 'none';
      // Index
      if (photos.length > 1) {
        photoIndex.textContent = `${(idx % photos.length) + 1} / ${photos.length}`;
        photoIndex.style.display = 'inline';
      } else {
        photoIndex.style.display = 'none';
      }

      lastSlideIndex = idx;
    }

    function nextSlide() {
      const photos = getCurrentPhotos();
      if (!photos.length) return;
      slideIndex = (slideIndex + 1) % photos.length;
      showSlide(slideIndex);
    }

    function prevSlide() {
      const photos = getCurrentPhotos();
      if (!photos.length) return;
      slideIndex = (slideIndex - 1 + photos.length) % photos.length;
      showSlide(slideIndex);
    }

    function restartSlideshow() {
      if (slideTimer) clearInterval(slideTimer);
      const photos = getCurrentPhotos();
      if (!photos.length) return;
      slideTimer = setInterval(nextSlide, 6000);
    }

    // --- Input Handlers ---
    // Mouse swipe
    let mouseDown = false, mouseStartX = 0, mouseStartY = 0, mouseMoved = false, swipeLocked = false;
    slideImg.addEventListener('mousedown', e => {
      if (swipeLocked) return;
      mouseDown = true; mouseMoved = false;
      mouseStartX = e.clientX; mouseStartY = e.clientY;
    });
    window.addEventListener('mousemove', e => { if (mouseDown) mouseMoved = true; });
    window.addEventListener('mouseup', e => {
      if (!mouseDown || swipeLocked) return;
      mouseDown = false;
      if (!mouseMoved) return;
      const dx = e.clientX - mouseStartX, dy = Math.abs(e.clientY - mouseStartY);
      if (Math.abs(dx) > 50 && dy < 80) {
        swipeLocked = true;
        dx < 0 ? nextSlide() : prevSlide();
        setTimeout(() => { swipeLocked = false; }, 650);
        restartSlideshow();
      }
    });

    // Touch swipe
    let touchStartX = 0, touchStartY = 0, touchActive = false, touchSwipeLocked = false;
    slideImg.addEventListener('touchstart', e => {
      if (touchSwipeLocked) return;
      if (e.touches.length === 1) {
        touchActive = true;
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
      }
    });
    slideImg.addEventListener('touchend', e => {
      if (touchSwipeLocked || !touchActive) return;
      touchActive = false;
      if (e.changedTouches.length === 1) {
        const dx = e.changedTouches[0].clientX - touchStartX;
        const dy = Math.abs(e.changedTouches[0].clientY - touchStartY);
        if (Math.abs(dx) > 50 && dy < 80) {
          touchSwipeLocked = true;
          dx < 0 ? nextSlide() : prevSlide();
          setTimeout(() => { touchSwipeLocked = false; }, 650);
          restartSlideshow();
        }
      }
    });

    // Keyboard
    document.addEventListener('keydown', e => {
      if (e.key === 'ArrowLeft') { prevSlide(); restartSlideshow(); }
      else if (e.key === 'ArrowRight') { nextSlide(); restartSlideshow(); }
    });

    // --- Init ---
    async function initGallery() {
      await fetchCollections();
      renderSwitcher();
      updateMemoriesLabel();
      showSlide(slideIndex, true);
      restartSlideshow();
    }
    window.addEventListener('DOMContentLoaded', initGallery);
  </script>
</body>
</html>
