<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Immich Kiosk Gallery</title>
  <link rel="stylesheet" href="/static/slideshow.css">
</head>
<body>
  <header class="gallery-header">
  <!-- Swiper CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <header class="gallery-header">
    <div id="collection-switcher" class="collection-switcher"></div>
    <div id="memories-label" class="memories-label">Spomienky</div>
  </header>
  <main>
    <div id="slideshow" class="slideshow">
      <div class="swiper">
        <div class="swiper-wrapper" id="swiper-wrapper"></div>
        <div class="swiper-pagination"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-button-next"></div>
      </div>
      <div id="loading" class="loading">Načítavam fotky...</div>
    </div>
    <div id="photo-meta" class="photo-meta">
      <span id="photo-date"></span>
      <span id="photo-author"></span>
      <span id="photo-location"></span>
      <span id="photo-index"></span>
    </div>
  </main>
  <!-- Swiper JS -->
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
    // --- Immich Kiosk Gallery Swiper ---
    const switcher = document.getElementById('collection-switcher');
    const memoriesLabel = document.getElementById('memories-label');
    const loading = document.getElementById('loading');
    const photoDate = document.getElementById('photo-date');
    const photoAuthor = document.getElementById('photo-author');
    const photoLocation = document.getElementById('photo-location');
    const photoIndex = document.getElementById('photo-index');
    const swiperWrapper = document.getElementById('swiper-wrapper');

    let collections = { memories: [], random: [] };
    let currentCollection = 'memories';
    let swiper = null;

    function showLoading(show) {
      loading.style.display = show ? 'block' : 'none';
    }

    async function fetchCollections() {
      showLoading(true);
      const [memoriesRes, randomRes] = await Promise.all([
        fetch('/api/memories').then(r => r.json()),
        fetch('/api/randomPhotos').then(r => r.json())
      ]);
      collections.memories = (memoriesRes.success && memoriesRes.memories) ? memoriesRes.memories : [];
      collections.random = (randomRes.success && randomRes.photos) ? randomRes.photos : [];
      showLoading(false);
    }

    function availableCollections() {
      return Object.entries(collections)
        .filter(([k, v]) => Array.isArray(v) && v.length)
        .map(([k]) => k);
    }

    function renderSwitcher() {
      const avail = availableCollections();
      if (avail.length < 2) {
        switcher.style.display = 'none';
        return;
      }
      switcher.innerHTML = '';
      avail.forEach(col => {
        const label = document.createElement('label');
        label.className = 'switch-label';
        label.innerHTML = `<input type=\"radio\" name=\"collection\" value=\"${col}\" ${currentCollection===col?'checked':''}>${col==='memories'?'Spomienky':'Náhodné fotky'}`;
        label.onclick = () => switchCollection(col);
        switcher.appendChild(label);
      });
      switcher.style.display = 'flex';
    }

    function switchCollection(col) {
      if (col === currentCollection) return;
      currentCollection = col;
      updateMemoriesLabel();
      renderSlides();
      initSwiper();
    }

    function updateMemoriesLabel() {
      if (currentCollection === 'memories') {
        memoriesLabel.classList.add('active');
        memoriesLabel.style.display = 'block';
      } else {
        memoriesLabel.classList.remove('active');
        memoriesLabel.style.display = 'none';
      }
    }

    function getCurrentPhotos() {
      return collections[currentCollection] || [];
    }

    function renderSlides() {
      const photos = getCurrentPhotos();
      swiperWrapper.innerHTML = '';
      photos.forEach((photo, idx) => {
        const slide = document.createElement('div');
        slide.className = 'swiper-slide';
        slide.innerHTML = `
          <div class="slide-img-container">
            <img class="slide-img" src="${photo.full_image_url || photo.thumbnail_url}" data-thumb="${photo.thumbnail_url || ''}" alt="${photo.file_name || ''}" />
          </div>
        `;
        swiperWrapper.appendChild(slide);
      });
    }

    function updateMeta(idx) {
      const photos = getCurrentPhotos();
      if (!photos.length) {
        [photoDate, photoAuthor, photoLocation, photoIndex].forEach(el => el.style.display = 'none');
        return;
      }
      const photo = photos[idx % photos.length];
      // Date
      let dateStr = '';
      if (photo.file_created_at) {
        const d = new Date(photo.file_created_at);
        if (!isNaN(d.getTime())) {
          dateStr = d.toLocaleDateString('sk-SK', { year: 'numeric', month: 'long', day: 'numeric' });
        }
      }
      photoDate.textContent = dateStr;
      photoDate.style.display = dateStr ? 'inline' : 'none';
      // Author
      photoAuthor.textContent = photo.author ? `Autor: ${photo.author}` : '';
      photoAuthor.style.display = photo.author ? 'inline' : 'none';
      // Location
      let loc = '';
      if (photo.city) loc += photo.city;
      if (photo.state) loc += (loc ? ', ' : '') + photo.state;
      if (photo.country) loc += (loc ? ', ' : '') + photo.country;
      photoLocation.textContent = loc ? `Lokácia: ${loc}` : '';
      photoLocation.style.display = loc ? 'inline' : 'none';
      // Index
      if (photos.length > 1) {
        photoIndex.textContent = `${(idx % photos.length) + 1} / ${photos.length}`;
        photoIndex.style.display = 'inline';
      } else {
        photoIndex.style.display = 'none';
      }
    }

    function initSwiper() {
      if (swiper) { swiper.destroy(true, true); swiper = null; }
      swiper = new Swiper('.swiper', {
        loop: true,
        centeredSlides: true,
        spaceBetween: 30,
        effect: 'slide',
        speed: 600,
        keyboard: { enabled: true },
        pagination: { el: '.swiper-pagination', clickable: true },
        navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
        preloadImages: true,
        lazy: false,
        autoplay: {
          delay: 6000,
          disableOnInteraction: false,
          pauseOnMouseEnter: true
        },
        on: {
          slideChange: function () {
            updateMeta(this.realIndex);
          },
        },
      });
      updateMeta(swiper.realIndex || 0);
    }

    // --- Init ---
    async function initGallery() {
      await fetchCollections();
      renderSwitcher();
      updateMemoriesLabel();
      renderSlides();
      initSwiper();
    }
    window.addEventListener('DOMContentLoaded', initGallery);
  </script>
</body>
</html>
