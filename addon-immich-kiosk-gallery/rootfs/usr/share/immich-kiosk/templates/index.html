<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Immich Kiosk Gallery</title>
  <link rel="stylesheet" href="/static/slideshow.css">
</head>
<body>
  <div id="memories-label">Spomienky</div>
  <div id="switcher" style="display:none;"></div>
  <div id="slideshow-container">
    <img id="slide-img" class="slide-image" src="" alt="Slideshow" style="display:none;" />
  </div>
  <div id="photo-meta">
    <div id="photo-date"></div>
    <div id="photo-author"></div>
    <div id="photo-location"></div>
    <div id="photo-index"></div>
  </div>
  <div id="loading">Načítavam fotky...</div>
  <script>
    const switcher = document.getElementById('switcher');
    const memoriesLabel = document.getElementById('memories-label');
    const slideImg = document.getElementById('slide-img');
    const loading = document.getElementById('loading');
    const photoDate = document.getElementById('photo-date');
    const photoAuthor = document.getElementById('photo-author');
    const photoLocation = document.getElementById('photo-location');
    const photoIndex = document.getElementById('photo-index');

    let memories = [];
    let randomPhotos = [];
    let currentCollection = 'memories';
    let slideshowPhotos = [];
    let slideIndex = 0;
    let slideTimer = null;
    let availableCollections = [];

    function showLoading(show) {
      loading.style.display = show ? 'block' : 'none';
    }

    async function fetchCollection(url) {
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.success) return data;
        return { success: false, items: [] };
      } catch {
        return { success: false, items: [] };
      }
    }

    async function loadPhotos() {
      showLoading(true);
      // Fetch both collections in parallel
      const [memoriesRes, randomRes] = await Promise.all([
        fetch('/api/memories').then(r => r.json()),
        fetch('/api/randomPhotos').then(r => r.json())
      ]);
      memories = (memoriesRes.success && memoriesRes.memories && memoriesRes.memories.length) ? memoriesRes.memories : [];
      randomPhotos = (randomRes.success && randomRes.photos && randomRes.photos.length) ? randomRes.photos : [];

      availableCollections = [];
      if (memories.length) availableCollections.push('memories');
      if (randomPhotos.length) availableCollections.push('random');

      // Set default collection
      if (!availableCollections.includes(currentCollection)) {
        currentCollection = availableCollections[0] || 'memories';
      }

      renderSwitcher();
      updateSlideshowPhotos();
      showLoading(false);
      startSlideshow();
    }

    function renderSwitcher() {
      if (availableCollections.length < 2) {
        switcher.style.display = 'none';
        return;
      }
      switcher.innerHTML = '';
      if (availableCollections.includes('memories')) {
        const label = document.createElement('label');
        label.innerHTML = `<input type="radio" name="collection" value="memories" ${currentCollection==='memories'?'checked':''}>Spomienky`;
        label.onclick = () => switchCollection('memories');
        switcher.appendChild(label);
      }
      if (availableCollections.includes('random')) {
        const label = document.createElement('label');
        label.innerHTML = `<input type="radio" name="collection" value="random" ${currentCollection==='random'?'checked':''}>Náhodné fotky`;
        label.onclick = () => switchCollection('random');
        switcher.appendChild(label);
      }
      switcher.style.display = 'flex';
    }

    function switchCollection(col) {
      if (col === currentCollection) return;
      currentCollection = col;
      updateSlideshowPhotos();
      startSlideshow();
    }

    function updateSlideshowPhotos() {
      if (currentCollection === 'memories') {
        slideshowPhotos = memories;
        memoriesLabel.classList.add('active');
      } else {
        slideshowPhotos = randomPhotos;
        memoriesLabel.classList.remove('active');
      }
      slideIndex = 0;
    }

    function showSlide(idx) {
      if (!slideshowPhotos.length) {
        slideImg.style.display = 'none';
        photoDate.style.display = 'none';
        photoAuthor.style.display = 'none';
        photoLocation.style.display = 'none';
        photoIndex.style.display = 'none';
        return;
      }
      const photo = slideshowPhotos[idx % slideshowPhotos.length];

      // Fade out current image
      slideImg.classList.remove('fade-in');
      slideImg.classList.add('fade-out');

      setTimeout(() => {
        slideImg.src = photo.full_image_url || photo.thumbnail_url;
        slideImg.style.display = 'block';
        // After image loads, fade in
        slideImg.onload = () => {
          slideImg.classList.remove('fade-out');
          slideImg.classList.add('fade-in');
        };
        // If cached, trigger fade-in immediately
        if (slideImg.complete) {
          slideImg.classList.remove('fade-out');
          slideImg.classList.add('fade-in');
        }
      }, 200);

      // Show date
      let dateStr = '';
      if (photo.file_created_at) {
        const d = new Date(photo.file_created_at);
        if (!isNaN(d.getTime())) {
          dateStr = d.toLocaleDateString('sk-SK', { year: 'numeric', month: 'long', day: 'numeric' });
        }
      }
      if (dateStr) {
        photoDate.textContent = dateStr;
        photoDate.style.display = 'block';
      } else {
        photoDate.style.display = 'none';
      }

      // Show author
      if (photo.author) {
        photoAuthor.textContent = `Autor: ${photo.author}`;
        photoAuthor.style.display = 'block';
      } else {
        photoAuthor.style.display = 'none';
      }

      // Show location
      let loc = '';
      if (photo.city) loc += photo.city;
      if (photo.state) loc += (loc ? ', ' : '') + photo.state;
      if (photo.country) loc += (loc ? ', ' : '') + photo.country;
      if (loc) {
        photoLocation.textContent = `Lokácia: ${loc}`;
        photoLocation.style.display = 'block';
      } else {
        photoLocation.style.display = 'none';
      }

      // Show index indicator
      if (slideshowPhotos.length > 1) {
        photoIndex.textContent = `${(idx % slideshowPhotos.length) + 1} / ${slideshowPhotos.length}`;
        photoIndex.style.display = 'block';
      } else {
        photoIndex.style.display = 'none';
      }
    }
    // Mouse swipe support
    let mouseDown = false;
    let mouseStartX = 0;
    let mouseStartY = 0;

    slideImg.addEventListener('mousedown', function(e) {
      mouseDown = true;
      mouseStartX = e.clientX;
      mouseStartY = e.clientY;
    });
    window.addEventListener('mouseup', function(e) {
      if (!mouseDown) return;
      mouseDown = false;
      const dx = e.clientX - mouseStartX;
      const dy = Math.abs(e.clientY - mouseStartY);
      if (Math.abs(dx) > 50 && dy < 80) {
        if (dx < 0) {
          nextSlide();
        } else {
          prevSlide();
        }
        if (slideTimer) {
          clearInterval(slideTimer);
          slideTimer = setInterval(nextSlide, 6000);
        }
      }
    });


    function nextSlide() {
      if (!slideshowPhotos.length) return;
      slideIndex = (slideIndex + 1) % slideshowPhotos.length;
      showSlide(slideIndex);
    }

    function prevSlide() {
      if (!slideshowPhotos.length) return;
      slideIndex = (slideIndex - 1 + slideshowPhotos.length) % slideshowPhotos.length;
      showSlide(slideIndex);
    }

    function startSlideshow() {
      if (slideTimer) clearInterval(slideTimer);
      if (!slideshowPhotos.length) {
        slideImg.style.display = 'none';
        return;
      }
      showSlide(slideIndex);
      slideTimer = setInterval(nextSlide, 6000);
    }

    // Touch/Swipe support
    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartY = 0;
    let touchEndY = 0;
    const minSwipeDistance = 50;

    slideImg.addEventListener('touchstart', function(e) {
      if (e.touches.length === 1) {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
      }
    });
    slideImg.addEventListener('touchend', function(e) {
      if (e.changedTouches.length === 1) {
        touchEndX = e.changedTouches[0].clientX;
        touchEndY = e.changedTouches[0].clientY;
        handleSwipe();
      }
    });

    function handleSwipe() {
      const dx = touchEndX - touchStartX;
      const dy = Math.abs(touchEndY - touchStartY);
      if (Math.abs(dx) > minSwipeDistance && dy < 80) {
        if (dx < 0) {
          nextSlide();
        } else {
          prevSlide();
        }
        if (slideTimer) {
          clearInterval(slideTimer);
          slideTimer = setInterval(nextSlide, 6000);
        }
      }
    }

    // Also allow left/right arrow keys for navigation
    document.addEventListener('keydown', function(e) {
      if (e.key === 'ArrowLeft') {
        prevSlide();
        if (slideTimer) {
          clearInterval(slideTimer);
          slideTimer = setInterval(nextSlide, 6000);
        }
      } else if (e.key === 'ArrowRight') {
        nextSlide();
        if (slideTimer) {
          clearInterval(slideTimer);
          slideTimer = setInterval(nextSlide, 6000);
        }
      }
    });

    window.addEventListener('DOMContentLoaded', loadPhotos);
  </script>
</body>
</html>
